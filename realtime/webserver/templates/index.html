<script src="{{url_for('static', filename='js/socket.io-1.4.5.js')}}"></script>
<h1>
    Flask SQLAlchemy and SocketIO demo
</h1>

<a href="{{ url_for('realtime.webserver.views.delete') }}">
    Delete all updates
</a>

<h3>
    Updates
</h3>
<table id="updates-table" border=1>
    <tr>
        <th>ID</th>
        <th>Timestamp</th>
        <th>Message</th>
    </tr>
    {% for update in updates %}
    <tr id="{{update.id}}-row">
        {% for column in  %}
        <td>{{ update.id }}</td>
        <td>{{ update.timestamp }}</td>
        <td>{{ update.message }}</td>
    </tr>
    {% endfor %}
</table>


<script>
    var socket = io.connect('/browser', {
        'reconnection': true,
        'reconnectionDelay': 500,
        'randomizationFactor': 0.5,
        'reconnectionAttempts': 'Infinity'
    });
    document.onbeforeunload = function () {
        console.log('Disconnecting from SocketIO ...');
        socket.disconnect();
    };
    socket.on('connect', function () {
        console.log('SocketIO connected.');
    });
    function appendRow(row_data) {
        var new_row = document.createElement('tr');
        var columns = {{ columns|safe }}
        new_row.setAttribute('id', data['id'] + '-row');
        for (var i = 0; i < length(columns); i++) {
            var new_cell = document.createElement('td');
            new_cell.innerText = row_data[columns[i]];
   // TODO: Finish creating function
        }
        new_row.appendChild();
        new_row.innerHTML = data['message'] + ' at ' + data['timestamp'];
        document.getElementById("updates-tables").appendChild(new_row);

    };
    socket.on('insert', function (data) {
        appendRow(data);
    });
    socket.on('update', function (data) {
        var old_version = document.getElementById(data['id']);
        var new_version = document.createElement('li');
        new_version.setAttribute("id", data['id']);
        new_version.innerHTML = data['message'] + ' at ' + data['timestamp'];
        document.getElementById("update-list").replaceChild(new_version, old_version);
    });
    socket.on('delete', function (data) {
        var old_version = document.getElementById(data['id']);
        document.getElementById("update-list").removeChild(old_version);
    });
</script>
